#!/bin/sh
#
# Configure script for 'lmytfy'
# Copyright 2014-2016, Truveris Inc. All Rights Reserved.
#
#

PROG="lmytfy"
VERSION="0.2.0"


# Some shells have shitty echos
alias echo=/bin/echo


# generate_makefile() - Generate the main Makefile
# $1 - source makefile, appended at the end
generate_makefile() {
	echo "# Automagically generated by 'configure'"
	echo

	echo "PROG_IRC=$PROG-irc"
	echo "PROG_MATTERMOST=$PROG-mattermost"
	echo "CFLAGS+=$CFLAGS -std=c99 -pedantic"
	echo "CFLAGS+=-Wall -W -Wpointer-arith -Wbad-function-cast -Wcast-qual"
	echo "CFLAGS+=-Wstrict-prototypes -Wmissing-prototypes"
	echo "CFLAGS+=-Wmissing-declarations -Wnested-externs -Winline"
	echo "CFLAGS+=-DVERSION=\\\"$VERSION\\\" $X_CFLAGS"

	if [ "$DEBUG_MODE" = "Y" ]; then
		echo "CFLAGS+=-ggdb -O0"
	else
		echo "CFLAGS+=-O2"
	fi

	if [ -n "$X_OBJECTS" ]; then
		echo "EXTRA_OBJECTS=$X_OBJECTS"
	fi

	echo "CC?=$CC"
	echo "PREFIX?=$PREFIX"

	cat "$1"
}


# usage() - Spit out basic help
usage() {
	echo "usage: ./configure [-hd] [--prefix path] [platform]"
	echo
	echo "    -h              this help screen."
	echo "    -d              configure for debug mode (-ggdb -O0)"
	echo "    --prefix path   base path for installation"
	echo
	exit
}


# stuff_not_found() - Exit 'cause we're missing something
stuff_not_found() {
	message="$1"
	echo "not found"
	echo
	echo ERROR: $message
	exit 2
}


# Command-line arguments
while true; do
	case "$1" in
		-h|--help)
			usage
			exit 2
			;;

		-d|--debug)
			echo "Debug mode... enabled"
			DEBUG_MODE="Y"
			shift
			;;

		--prefix=*)
			PREFIX="${1##--prefix=}"
			shift
			;;

		# Skip all random long opts passed by packagers thinking this
		# is autoconf-compatible.
		--*)
			shift
			;;

		*)
			break
			;;
	esac
done


# Detect platform
echo -n "Target platform... "
OS=`uname`
if [ -n "$1" ]; then
	OS="$1"
fi
echo $OS


# Platform-specific configuration
case $OS in
	Linux|Unix|POSIX)
		X_CFLAGS="-D_GNU_SOURCE"
		;;
esac


# Default paths
[ -z "$PREFIX" ]	&& PREFIX="/usr"


# Check for make
echo -n "make... "
cat <<EOF > fake_makefile
all:
	@echo found
EOF
if ! make -f fake_makefile 1>/dev/null 2>/dev/null; then
	stuff_not_found "Make not found (try to install make or gmake)"
fi
echo found
rm -f fake_makefile*


# Check if we have a working cc
if [ -z "$CC" ]; then
	if cc -v 1>/dev/null 2>/dev/null; then
		export CC=cc
	elif gcc -v 1>/dev/null 2>/dev/null; then
		export CC=gcc
	else
		stuff_not_found "No C compiler found (try to install clang or gcc)"
	fi
fi

echo -n "cc... "
cat <<EOF > fake_cc.c
#include <stdio.h>
main() { printf("woot\n"); }
EOF
if ! ${CC} fake_cc.c -o /dev/null 1>/dev/null 2>/dev/null; then
	stuff_not_found "Detected compiler (${CC}) is not working"
fi
echo ${CC}
rm -f fake_cc*


# Check if we have strlcpy
echo -n "strlcpy... "
cat <<EOF > fake_strlcpy.c
main() { char buf[32]; strlcpy(buf, "woot", sizeof(buf)); }
EOF
if ! ${CC} fake_strlcpy.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS strlcpy.o"
	CFLAGS="$CFLAGS -DHAS_NO_STRLCPY"
else
	echo yes
fi
rm -f fake_strlcpy*


# Check if we have strtonum
echo -n "strtonum... "
cat <<EOF > fake_strtonum.c
main() { int i; const char *errstr; i = strtonum("42", 1, 64, &errstr); }
EOF
if ! ${CC} fake_strtonum.c -o /dev/null 1>/dev/null 2>/dev/null; then
	echo "not found (we'll use ours)"
	X_OBJECTS="$X_OBJECTS strtonum.o"
	CFLAGS="$CFLAGS -DHAS_NO_STRTONUM"
else
	echo yes
fi
rm -f fake_strtonum*


echo
find . -name "Makefile.src" | while read input; do
	output=${input%%.src}
	echo "generating $output"
	generate_makefile $input > $output
done

echo
echo "Run 'make' (or 'gmake') to compile and 'sudo make install' to install."
